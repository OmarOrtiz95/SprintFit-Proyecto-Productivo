// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  CUSTOMER
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  PREPARING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  APPROVED
  DECLINED
  VOIDED
  ERROR
}

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  fullName      String    @map("full_name")
  phone         String?
  role          Role      @default(CUSTOMER)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  orders        Order[]

  @@map("users")
}

model Category {
  id        Int        @id @default(autoincrement())
  name      String
  slug      String     @unique
  parentId  Int?       @map("parent_id")
  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryHierarchy")
  products  Product[]

  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  @@map("categories")
}

model Product {
  id            Int       @id @default(autoincrement())
  name          String
  description   String    @db.Text
  sku           String    @unique
  price         Decimal   @db.Decimal(10, 2)
  stockQuantity Int       @default(0) @map("stock_quantity")
  isActive      Boolean   @default(true) @map("is_active")
  attributes    Json?     // Flexible JSON for sizes, colors, etc.
  
  categoryId    Int       @map("category_id")
  category      Category  @relation(fields: [categoryId], references: [id])
  
  images        ProductImage[]
  orderItems    OrderItem[]

  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("products")
}

model ProductImage {
  id           Int      @id @default(autoincrement())
  url          String
  displayOrder Int      @default(0) @map("display_order")
  
  productId    Int      @map("product_id")
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

model Order {
  id              Int         @id @default(autoincrement())
  totalAmount     Decimal     @map("total_amount") @db.Decimal(10, 2)
  status          OrderStatus @default(PENDING_PAYMENT)
  shippingAddress String      @map("shipping_address") @db.Text
  phone           String?
  
  userId          Int         @map("user_id")
  user            User        @relation(fields: [userId], references: [id])

  items           OrderItem[]
  payments        Payment[]

  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@map("orders")
}

model OrderItem {
  id            Int     @id @default(autoincrement())
  quantity      Int
  unitPrice     Decimal @map("unit_price") @db.Decimal(10, 2) // Price at moment of purchase
  
  orderId       Int     @map("order_id")
  order         Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId     Int     @map("product_id")
  product       Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model Payment {
  id                   Int           @id @default(autoincrement())
  amount               Decimal       @db.Decimal(10, 2)
  status               PaymentStatus @default(PENDING)
  transactionReference String        @unique @map("transaction_reference") // Wompi ID / Nequi Ref
  providerResponse     Json?         @map("provider_response")
  
  orderId              Int           @map("order_id")
  order                Order         @relation(fields: [orderId], references: [id])

  createdAt            DateTime      @default(now()) @map("created_at")
  updatedAt            DateTime      @updatedAt @map("updated_at")

  @@map("payments")
}
